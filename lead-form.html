<!-- Форма заявки для IKEBER -->
<div id="leadModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-slate-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <!-- Заголовок и кнопка закрытия -->
        <div class="flex justify-between items-center p-6 border-b border-slate-700">
            <h3 class="text-xl font-bold text-white">Оставить заявку</h3>
            <button id="closeLeadModal" class="text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <!-- Форма -->
        <form id="leadForm" class="p-6 space-y-4">
            <!-- Имя -->
            <div>
                <label for="name" class="block text-sm font-medium text-slate-300 mb-2">Имя *</label>
                <input type="text" id="name" name="name" required
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors"
                       placeholder="Ваше имя">
                <div id="nameError" class="text-red-400 text-sm mt-1 hidden"></div>
            </div>
            
            <!-- Телефон -->
            <div>
                <label for="phone" class="block text-sm font-medium text-slate-300 mb-2">Телефон *</label>
                <input type="tel" id="phone" name="phone" required
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors"
                       placeholder="+7 (999) 123-45-67">
                <div id="phoneError" class="text-red-400 text-sm mt-1 hidden"></div>
            </div>
            
            <!-- Email -->
            <div>
                <label for="email" class="block text-sm font-medium text-slate-300 mb-2">Email *</label>
                <input type="email" id="email" name="email" required
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors"
                       placeholder="your@email.com">
                <div id="emailError" class="text-red-400 text-sm mt-1 hidden"></div>
            </div>
            
            <!-- Тариф -->
            <div>
                <label for="tariff" class="block text-sm font-medium text-slate-300 mb-2">Выберите тариф *</label>
                <select id="tariff" name="tariff" required
                        class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500 transition-colors">
                    <option value="">Выберите тариф</option>
                    <option value="Начальный">Начальный - 3000₽/мес</option>
                    <option value="Логистика">Логистика - 10000₽/мес</option>
                    <option value="Маркетинг Плюс">Маркетинг Плюс - 15000₽/мес</option>
                </select>
                <div id="tariffError" class="text-red-400 text-sm mt-1 hidden"></div>
            </div>
            
            <!-- Название бизнеса -->
            <div>
                <label for="businessName" class="block text-sm font-medium text-slate-300 mb-2">Название бизнеса</label>
                <input type="text" id="businessName" name="businessName"
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors"
                       placeholder="Название вашего магазина или компании">
            </div>
            
            <!-- Тип бизнеса -->
            <div>
                <label for="businessType" class="block text-sm font-medium text-slate-300 mb-2">Тип бизнеса</label>
                <select id="businessType" name="businessType"
                        class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500 transition-colors">
                    <option value="">Выберите тип бизнеса</option>
                    <option value="Розничная торговля">Розничная торговля</option>
                    <option value="Услуги">Услуги</option>
                    <option value="Производство">Производство</option>
                    <option value="Кафе/Ресторан">Кафе/Ресторан</option>
                    <option value="Другое">Другое</option>
                </select>
            </div>
            
            <!-- Количество товаров -->
            <div>
                <label for="productCount" class="block text-sm font-medium text-slate-300 mb-2">Количество товаров</label>
                <select id="productCount" name="productCount"
                        class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500 transition-colors">
                    <option value="">Выберите количество</option>
                    <option value="до 50">до 50 товаров</option>
                    <option value="50-200">50-200 товаров</option>
                    <option value="200-500">200-500 товаров</option>
                    <option value="500+">более 500 товаров</option>
                </select>
            </div>
            
            <!-- Город -->
            <div>
                <label for="city" class="block text-sm font-medium text-slate-300 mb-2">Город</label>
                <input type="text" id="city" name="city"
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors"
                       placeholder="Ваш город">
            </div>
            
            <!-- Комментарий -->
            <div>
                <label for="comment" class="block text-sm font-medium text-slate-300 mb-2">Комментарий или вопросы</label>
                <textarea id="comment" name="comment" rows="3"
                          class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500 transition-colors resize-none"
                          placeholder="Есть вопросы или особые пожелания?"></textarea>
            </div>
            
            <!-- Скрытые поля -->
            <input type="hidden" id="source" name="source" value="Сайт">
            <input type="hidden" id="ipAddress" name="ipAddress">
            
            <!-- Кнопка отправки -->
            <div class="pt-4">
                <button type="submit" id="submitBtn"
                        class="w-full bg-cyan-500 hover:bg-cyan-600 text-white py-3 px-6 rounded-lg font-bold transition duration-300 flex items-center justify-center gap-2">
                    <span id="submitText">Отправить заявку</span>
                    <i id="submitSpinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </div>
        </form>
        
        <!-- Сообщение об успехе -->
        <div id="successMessage" class="hidden p-6 text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-white text-2xl"></i>
            </div>
            <h4 class="text-xl font-bold text-white mb-2">Заявка отправлена!</h4>
            <p class="text-slate-300 mb-4">Мы свяжемся с вами в ближайшее время</p>
            <button id="closeSuccess" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 rounded-lg font-medium transition duration-300">
                Закрыть
            </button>
        </div>
    </div>
</div>

<script>
// Конфигурация
const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE'; // Заменить на реальный URL

// Элементы DOM
const leadModal = document.getElementById('leadModal');
const closeLeadModal = document.getElementById('closeLeadModal');
const leadForm = document.getElementById('leadForm');
const successMessage = document.getElementById('successMessage');
const closeSuccess = document.getElementById('closeSuccess');
const submitBtn = document.getElementById('submitBtn');
const submitText = document.getElementById('submitText');
const submitSpinner = document.getElementById('submitSpinner');

// Функции для работы с модальным окном
function openLeadModal() {
    leadModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    // Получаем IP адрес
    getIPAddress();
}

function closeLeadModalFunc() {
    leadModal.classList.add('hidden');
    document.body.style.overflow = '';
    resetForm();
}

// Получение IP адреса
async function getIPAddress() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        document.getElementById('ipAddress').value = data.ip;
    } catch (error) {
        console.error('Не удалось получить IP адрес:', error);
        document.getElementById('ipAddress').value = 'unknown';
    }
}

// Валидация формы
function validateForm(data) {
    let isValid = true;
    
    // Очистка предыдущих ошибок
    clearErrors();
    
    // Валидация имени
    if (!data.name.trim()) {
        showError('nameError', 'Введите ваше имя');
        isValid = false;
    }
    
    // Валидация телефона
    const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
    if (!phoneRegex.test(data.phone.replace(/\D/g, ''))) {
        showError('phoneError', 'Введите корректный номер телефона');
        isValid = false;
    }
    
    // Валидация email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
        showError('emailError', 'Введите корректный email');
        isValid = false;
    }
    
    // Валидация тарифа
    if (!data.tariff) {
        showError('tariffError', 'Выберите тариф');
        isValid = false;
    }
    
    return isValid;
}

// Показать ошибку
function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.textContent = message;
    errorElement.classList.remove('hidden');
}

// Очистить ошибки
function clearErrors() {
    const errorElements = document.querySelectorAll('[id$="Error"]');
    errorElements.forEach(element => {
        element.classList.add('hidden');
        element.textContent = '';
    });
}

// Сброс формы
function resetForm() {
    leadForm.reset();
    clearErrors();
    leadForm.classList.remove('hidden');
    successMessage.classList.add('hidden');
}

// Отправка формы
async function submitForm(formData) {
    try {
        // Показываем спиннер
        submitText.textContent = 'Отправка...';
        submitSpinner.classList.remove('hidden');
        submitBtn.disabled = true;
        
        // Отправляем данные в Apps Script
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Успешная отправка
            leadForm.classList.add('hidden');
            successMessage.classList.remove('hidden');
        } else {
            // Ошибка сервера
            throw new Error(result.error || 'Ошибка отправки заявки');
        }
        
    } catch (error) {
        console.error('Ошибка отправки заявки:', error);
        alert('Произошла ошибка при отправке заявки. Пожалуйста, попробуйте позже.');
    } finally {
        // Сбрасываем состояние кнопки
        submitText.textContent = 'Отправить заявку';
        submitSpinner.classList.add('hidden');
        submitBtn.disabled = false;
    }
}

// Обработчики событий
document.addEventListener('DOMContentLoaded', function() {
    // Открытие модального окна при клике на кнопки "Начать бесплатно"
    document.querySelectorAll('a[href="#pricing"]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            openLeadModal();
        });
    });
    
    // Закрытие модального окна
    closeLeadModal.addEventListener('click', closeLeadModalFunc);
    closeSuccess.addEventListener('click', closeLeadModalFunc);
    
    // Закрытие по клику на фон
    leadModal.addEventListener('click', function(e) {
        if (e.target === leadModal) {
            closeLeadModalFunc();
        }
    });
    
    // Закрытие по ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !leadModal.classList.contains('hidden')) {
            closeLeadModalFunc();
        }
    });
    
    // Отправка формы
    leadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            tariff: document.getElementById('tariff').value,
            businessName: document.getElementById('businessName').value,
            businessType: document.getElementById('businessType').value,
            productCount: document.getElementById('productCount').value,
            city: document.getElementById('city').value,
            source: document.getElementById('source').value,
            comment: document.getElementById('comment').value,
            ipAddress: document.getElementById('ipAddress').value
        };
        
        if (validateForm(formData)) {
            submitForm(formData);
        }
    });
});
</script>